{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2>Foglalj idopontot</h2>
  <label>Szolgaltatas</label>
  <select id="service"></select>
  <label>Fodrasz</label>
  <select id="stylist"></select>
  <label>Datum</label>
  <input type="date" id="date">
  <div id="slots" class="slots"></div>
  <div style="margin-top:12px">
    <label>Nev</label><input id="name" type="text">
    <label>Telefonszam</label><input id="phone" type="text">
    <label>Email (opcionalis)</label><input id="email" type="email">
    <button id="confirm"><img src="/static/icons/calendar.svg" style="width:18px;height:18px"> Foglalas</button>
  </div>
</div>
<script>
const servicesData = {{ services|tojson }};
const stylistsData = {{ stylists|tojson }};
function populate(){
  const s=document.getElementById('service'); const st=document.getElementById('stylist');
  servicesData.forEach(x=>{let o=document.createElement('option');o.value=x.id;o.textContent=`${x.name} (${x.duration_minutes} perc)`;s.appendChild(o)});
  stylistsData.forEach(x=>{let o=document.createElement('option');o.value=x.id;o.textContent=x.name;st.appendChild(o)});
}
async function loadSlots(){
  const date=document.getElementById('date').value; const stylist=document.getElementById('stylist').value; const service=document.getElementById('service').value;
  if(!date) return;
  const res=await fetch(`/api/availability?stylist=${stylist}&date=${date}&service=${service}`);
  const data=await res.json(); const slots=document.getElementById('slots'); slots.innerHTML='';
  data.slots.forEach(s=>{const d=new Date(s.start); const btn=document.createElement('button'); btn.className='slot'; btn.textContent=d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); btn.disabled=!s.free; if(s.free){btn.addEventListener('click', ()=>{document.querySelectorAll('.slot.selected').forEach(x=>x.classList.remove('selected')); btn.classList.add('selected'); btn.dataset.start=s.start;});} slots.appendChild(btn);});
}
document.addEventListener('DOMContentLoaded', ()=>{ populate(); document.getElementById('date').addEventListener('change', loadSlots); document.getElementById('service').addEventListener('change', loadSlots); document.getElementById('stylist').addEventListener('change', loadSlots); document.getElementById('confirm').addEventListener('click', async ()=>{ const name=document.getElementById('name').value.trim(); const phone=document.getElementById('phone').value.trim(); const email=document.getElementById('email').value.trim(); const sel=document.querySelector('.slot.selected'); if(!name||!phone||!sel){alert('Kerlek toltsd ki a kotelezo mezoket es valassz idopontot.'); return;} const payload={name,phone,email,stylist:document.getElementById('stylist').value,service:document.getElementById('service').value,start:sel.dataset.start}; const res=await fetch('/book',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)}); const data=await res.json(); if(data.ok){alert('Foglalas sikeres!'); window.location.href='/';} else if(data.error){alert('Hiba: '+data.error);} else {alert('Hiba tortent.');} }); });
</script>
{% endblock %}
