{% extends 'base.html' %}
{% block content %}
<div class="card fade-in">
  <h2>Foglalj időpontot</h2>

  <label>Szolgáltatás</label>
  <select id="service"></select>

  <label>Fodrász</label>
  <select id="stylist"></select>

  <label>Dátum</label>
  <input type="date" id="date" />

  <div id="slots" class="slots"></div>

  <div class="card small">
    <input id="name" placeholder="Név" />
    <input id="phone" placeholder="Telefonszám" />
    <input id="email" placeholder="Email (opcionális)" />
    <button id="confirm" class="primary"><i data-feather="calendar"></i> Foglalás</button>
  </div>
</div>

<script>
const servicesData = {{ services|tojson }};
const stylistsData = {{ stylists|tojson }};

function populateSelects(){
  const sSel = document.getElementById('service');
  const stSel = document.getElementById('stylist');
  servicesData.forEach(s=>{ const o = document.createElement('option'); o.value=s.id; o.textContent=`${s.name} (${s.duration_minutes} perc)`; sSel.appendChild(o)});
  stylistsData.forEach(s=>{ const o = document.createElement('option'); o.value=s.id; o.textContent=s.name; stSel.appendChild(o)});
}

async function loadSlots(){
  const date = document.getElementById('date').value;
  const stylist = document.getElementById('stylist').value;
  const service = document.getElementById('service').value;
  if(!date) return;
  const res = await fetch(`/api/availability?stylist=${stylist}&date=${date}&service=${service}`);
  const data = await res.json();
  const slots = document.getElementById('slots');
  slots.innerHTML='';
  data.slots.forEach(s=>{
    const d = new Date(s.start);
    const btn = document.createElement('button');
    btn.className='slot';
    btn.textContent = d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    btn.disabled = !s.free;
    if(s.free){
      btn.addEventListener('click', ()=>{
        document.querySelectorAll('.slot.selected').forEach(x=>x.classList.remove('selected'));
        btn.classList.add('selected');
        btn.dataset.start = s.start;
      });
    }
    slots.appendChild(btn);
  });
}

document.addEventListener('DOMContentLoaded', ()=>{
  populateSelects();
  document.getElementById('date').addEventListener('change', loadSlots);
  document.getElementById('service').addEventListener('change', loadSlots);
  document.getElementById('stylist').addEventListener('change', loadSlots);
  document.getElementById('confirm').addEventListener('click', async ()=>{
    const name = document.getElementById('name').value.trim();
    const phone = document.getElementById('phone').value.trim();
    const email = document.getElementById('email').value.trim();
    const sel = document.querySelector('.slot.selected');
    if(!name || !phone || !sel){ alert('Kérlek töltsd ki a nevet, telefonszámot és válassz időpontot.'); return; }
    const payload = { name, phone, email, stylist: document.getElementById('stylist').value, service: document.getElementById('service').value, start: sel.dataset.start };
    const res = await fetch('/book', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    const data = await res.json();
    if(data.ok){ alert('Foglalás sikeres!'); window.location.href='/'; } else { alert('Hiba: '+(data.error||'')); }
  });
});
</script>
{% endblock %}
